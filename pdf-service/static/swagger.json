{
  "openapi": "3.0.3",
  "info": {
    "title": "PDF Service API",
    "description": "Microservice for PDF compression and processing with file management, instruction tracking, and S3 storage integration",
    "version": "1.0.0",
    "contact": {
      "name": "InstrLabs API Support",
      "email": "api@instrlabs.com"
    },
    "license": {
      "name": "MIT"
    }
  },
  "servers": [],
  "paths": {
    "/instructions": {
      "post": {
        "summary": "Create a new PDF processing instruction",
        "description": "Create a new instruction for PDF processing with the specified product. This creates an empty instruction record that can then receive file uploads.",
        "operationId": "createInstruction",
        "tags": ["Instructions"],
        "security": [
          {
            "userIdHeader": []
          },
          {
            "guestIdHeader": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["productId"],
                "properties": {
                  "productId": {
                    "type": "string",
                    "description": "Valid MongoDB ObjectID of the product to use for PDF processing",
                    "pattern": "^[a-f0-9]{24}$",
                    "example": "507f1f77bcf86cd799439011"
                  }
                }
              },
              "example": {
                "productId": "507f1f77bcf86cd799439011"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Instruction created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "Instruction created successfully"
                    },
                    "errors": {
                      "type": "null",
                      "nullable": true
                    },
                    "data": {
                      "$ref": "#/components/schemas/Instruction"
                    }
                  },
                  "required": ["message", "errors", "data"]
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "500": {
            "$ref": "#/components/responses/InternalServerError"
          }
        }
      }
    },
    "/instructions/{id}": {
      "get": {
        "summary": "Get PDF instruction by ID",
        "description": "Retrieve a specific PDF processing instruction by ID. User must own the instruction to access it.",
        "operationId": "getInstruction",
        "tags": ["Instructions"],
        "security": [
          {
            "userIdHeader": []
          },
          {
            "guestIdHeader": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "Instruction ID (MongoDB ObjectID format)",
            "schema": {
              "type": "string",
              "pattern": "^[a-f0-9]{24}$"
            },
            "example": "507f1f77bcf86cd799439011"
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully retrieved instruction",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "Success"
                    },
                    "errors": {
                      "type": "null",
                      "nullable": true
                    },
                    "data": {
                      "$ref": "#/components/schemas/Instruction"
                    }
                  },
                  "required": ["message", "errors", "data"]
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "500": {
            "$ref": "#/components/responses/InternalServerError"
          }
        }
      },
      "post": {
        "summary": "Upload PDF file for processing",
        "description": "Upload a PDF file to be processed (compressed) according to the instruction. Creates both input and output file records, with compression processing triggered via NATS message queue. File is validated before upload.",
        "operationId": "createInstructionDetails",
        "tags": ["Instructions"],
        "security": [
          {
            "userIdHeader": []
          },
          {
            "guestIdHeader": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "Instruction ID (MongoDB ObjectID format)",
            "schema": {
              "type": "string",
              "pattern": "^[a-f0-9]{24}$"
            },
            "example": "507f1f77bcf86cd799439011"
          }
        ],
        "requestBody": {
          "required": true,
          "description": "PDF file upload with multipart form data",
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "required": ["file"],
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "PDF file to compress. Must be a valid PDF file. Maximum file size limit depends on S3 configuration."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "File uploaded successfully and processing started",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "File uploaded successfully"
                    },
                    "errors": {
                      "type": "null",
                      "nullable": true
                    },
                    "data": {
                      "type": "array",
                      "description": "Array containing input and output file details",
                      "items": {
                        "$ref": "#/components/schemas/InstructionDetail"
                      }
                    }
                  },
                  "required": ["message", "errors", "data"]
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "413": {
            "$ref": "#/components/responses/RequestEntityTooLarge"
          },
          "500": {
            "$ref": "#/components/responses/InternalServerError"
          }
        }
      }
    },
    "/instructions/{id}/{detail_id}": {
      "get": {
        "summary": "Get instruction detail metadata",
        "description": "Retrieve metadata for a specific file (input or output) within an instruction, including processing status, file size, and timestamps.",
        "operationId": "getInstructionDetail",
        "tags": ["Instructions"],
        "security": [
          {
            "userIdHeader": []
          },
          {
            "guestIdHeader": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "Instruction ID (MongoDB ObjectID format)",
            "schema": {
              "type": "string",
              "pattern": "^[a-f0-9]{24}$"
            },
            "example": "507f1f77bcf86cd799439011"
          },
          {
            "name": "detail_id",
            "in": "path",
            "required": true,
            "description": "Detail ID (MongoDB ObjectID format) - identifier for the specific file",
            "schema": {
              "type": "string",
              "pattern": "^[a-f0-9]{24}$"
            },
            "example": "507f1f77bcf86cd799439012"
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully retrieved instruction detail metadata",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "Success"
                    },
                    "errors": {
                      "type": "null",
                      "nullable": true
                    },
                    "data": {
                      "$ref": "#/components/schemas/InstructionDetail"
                    }
                  },
                  "required": ["message", "errors", "data"]
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "500": {
            "$ref": "#/components/responses/InternalServerError"
          }
        }
      }
    },
    "/instructions/{id}/{detail_id}/file": {
      "get": {
        "summary": "Download processed PDF file",
        "description": "Download the actual PDF file content - either the original input file or the compressed output file. Returns binary PDF data with appropriate content-disposition header for download.",
        "operationId": "getInstructionDetailFile",
        "tags": ["Instructions"],
        "security": [
          {
            "userIdHeader": []
          },
          {
            "guestIdHeader": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "Instruction ID (MongoDB ObjectID format)",
            "schema": {
              "type": "string",
              "pattern": "^[a-f0-9]{24}$"
            },
            "example": "507f1f77bcf86cd799439011"
          },
          {
            "name": "detail_id",
            "in": "path",
            "required": true,
            "description": "Detail ID (MongoDB ObjectID format) - identifier for the file to download",
            "schema": {
              "type": "string",
              "pattern": "^[a-f0-9]{24}$"
            },
            "example": "507f1f77bcf86cd799439012"
          }
        ],
        "responses": {
          "200": {
            "description": "PDF file download successful",
            "content": {
              "application/pdf": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              },
              "application/octet-stream": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            },
            "headers": {
              "Content-Disposition": {
                "description": "File attachment information with original filename",
                "schema": {
                  "type": "string",
                  "example": "attachment; filename=document.pdf"
                }
              },
              "Content-Type": {
                "description": "MIME type of the file",
                "schema": {
                  "type": "string",
                  "example": "application/octet-stream"
                }
              }
            }
          },
          "400": {
            "$ref": "#/components/responses/BadRequest"
          },
          "401": {
            "$ref": "#/components/responses/Unauthorized"
          },
          "403": {
            "$ref": "#/components/responses/Forbidden"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          },
          "500": {
            "$ref": "#/components/responses/InternalServerError"
          }
        }
      }
    },
    "/health": {
      "get": {
        "summary": "Service health check",
        "description": "Check the health status of the PDF service. Returns service status, timestamp, and version information.",
        "operationId": "healthCheck",
        "tags": ["Health"],
        "responses": {
          "200": {
            "description": "Service is healthy and responding",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "string",
                      "enum": ["ok"],
                      "example": "ok"
                    },
                    "timestamp": {
                      "type": "string",
                      "format": "date-time",
                      "description": "UTC timestamp of health check",
                      "example": "2024-01-15T10:30:00Z"
                    },
                    "service": {
                      "type": "string",
                      "example": "pdf-service"
                    },
                    "version": {
                      "type": "string",
                      "description": "Service version",
                      "example": "1.0.0"
                    }
                  },
                  "required": ["status", "timestamp", "service"]
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "Instruction": {
        "type": "object",
        "description": "PDF processing instruction representing a user's request to process PDFs",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique instruction identifier (MongoDB ObjectID)",
            "pattern": "^[a-f0-9]{24}$",
            "example": "507f1f77bcf86cd799439011"
          },
          "userId": {
            "type": ["string", "null"],
            "nullable": true,
            "description": "ID of the authenticated user who created the instruction. Null for guest users.",
            "example": "user123"
          },
          "guestId": {
            "type": ["string", "null"],
            "nullable": true,
            "description": "ID of the guest user. Null for authenticated users.",
            "example": "guest_abc123"
          },
          "productId": {
            "type": "string",
            "description": "MongoDB ObjectID of the product used for processing",
            "pattern": "^[a-f0-9]{24}$",
            "example": "507f1f77bcf86cd799439011"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when the instruction was created (UTC)",
            "example": "2024-01-15T10:30:00Z"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when the instruction was last updated (UTC)",
            "example": "2024-01-15T10:35:00Z"
          }
        },
        "required": ["id", "productId", "createdAt", "updatedAt"]
      },
      "InstructionDetail": {
        "type": "object",
        "description": "File detail associated with an instruction, representing either input or compressed output PDF",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique detail identifier (MongoDB ObjectID)",
            "pattern": "^[a-f0-9]{24}$",
            "example": "507f1f77bcf86cd799439012"
          },
          "userId": {
            "type": ["string", "null"],
            "nullable": true,
            "description": "ID of the authenticated user. Null for guest users.",
            "example": "user123"
          },
          "guestId": {
            "type": ["string", "null"],
            "nullable": true,
            "description": "ID of the guest user. Null for authenticated users.",
            "example": "guest_abc123"
          },
          "fileName": {
            "type": "string",
            "description": "Original filename of the PDF",
            "example": "document.pdf"
          },
          "fileSize": {
            "type": "integer",
            "format": "int64",
            "description": "File size in bytes (0 for pending output files)",
            "example": 1048576
          },
          "status": {
            "type": "string",
            "enum": ["PENDING", "PROCESSING", "DONE", "FAILED", "CLEANED"],
            "description": "Current processing status of the file. PENDING: waiting to be processed, PROCESSING: actively being compressed, DONE: compression complete, FAILED: processing error, CLEANED: deleted from storage"
          },
          "type": {
            "type": "string",
            "enum": ["input", "output"],
            "description": "File type - 'input' is the original uploaded file, 'output' is the compressed result"
          },
          "filePath": {
            "type": "string",
            "description": "S3 storage path for the file",
            "example": "pdfs/507f1f77bcf86cd799439011_output.pdf"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when the file detail was created (UTC)",
            "example": "2024-01-15T10:30:00Z"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when the file detail was last updated, including status changes (UTC)",
            "example": "2024-01-15T10:35:00Z"
          }
        },
        "required": ["id", "fileName", "fileSize", "status", "type", "filePath", "createdAt", "updatedAt"]
      },
      "ErrorDetail": {
        "type": "object",
        "description": "Detailed error information",
        "properties": {
          "code": {
            "type": "string",
            "description": "Error code identifier"
          },
          "message": {
            "type": "string",
            "description": "Human-readable error message"
          }
        }
      }
    },
    "securitySchemes": {
      "userIdHeader": {
        "type": "apiKey",
        "in": "header",
        "name": "x-user-id",
        "description": "User ID header for authenticated users. Provide this OR x-guest-id, but at least one must be present."
      },
      "guestIdHeader": {
        "type": "apiKey",
        "in": "header",
        "name": "x-guest-id",
        "description": "Guest ID header for guest users. Provide this OR x-user-id, but at least one must be present."
      }
    },
    "responses": {
      "BadRequest": {
        "description": "Invalid request parameters or body",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "message": {
                  "type": "string",
                  "example": "Invalid request body"
                },
                "errors": {
                  "oneOf": [
                    {
                      "type": "null"
                    },
                    {
                      "type": "string"
                    },
                    {
                      "type": "object"
                    }
                  ],
                  "nullable": true,
                  "description": "Error details (null or error message/object)"
                },
                "data": {
                  "type": "null",
                  "nullable": true
                }
              },
              "required": ["message", "errors", "data"]
            }
          }
        }
      },
      "Unauthorized": {
        "description": "Missing or invalid authentication credentials. Either x-user-id or x-guest-id header must be provided.",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "message": {
                  "type": "string",
                  "example": "Unauthorized"
                },
                "errors": {
                  "type": "null",
                  "nullable": true
                },
                "data": {
                  "type": "null",
                  "nullable": true
                }
              },
              "required": ["message", "errors", "data"]
            }
          }
        }
      },
      "Forbidden": {
        "description": "User does not have permission to access this resource",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "message": {
                  "type": "string",
                  "example": "Access denied"
                },
                "errors": {
                  "type": "null",
                  "nullable": true
                },
                "data": {
                  "type": "null",
                  "nullable": true
                }
              },
              "required": ["message", "errors", "data"]
            }
          }
        }
      },
      "NotFound": {
        "description": "Requested resource not found",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "message": {
                  "type": "string",
                  "example": "Resource not found"
                },
                "errors": {
                  "type": "null",
                  "nullable": true
                },
                "data": {
                  "type": "null",
                  "nullable": true
                }
              },
              "required": ["message", "errors", "data"]
            }
          }
        }
      },
      "RequestEntityTooLarge": {
        "description": "Request entity (file) is too large to process",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "message": {
                  "type": "string",
                  "example": "File size exceeds maximum allowed size"
                },
                "errors": {
                  "type": "null",
                  "nullable": true
                },
                "data": {
                  "type": "null",
                  "nullable": true
                }
              },
              "required": ["message", "errors", "data"]
            }
          }
        }
      },
      "InternalServerError": {
        "description": "Internal server error occurred during processing",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "message": {
                  "type": "string",
                  "example": "Internal server error"
                },
                "errors": {
                  "oneOf": [
                    {
                      "type": "null"
                    },
                    {
                      "type": "string"
                    },
                    {
                      "type": "object"
                    }
                  ],
                  "nullable": true,
                  "description": "Error details (null or error message/object)"
                },
                "data": {
                  "type": "null",
                  "nullable": true
                }
              },
              "required": ["message", "errors", "data"]
            }
          }
        }
      }
    }
  }
}
